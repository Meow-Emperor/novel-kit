name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 当推送以 v 开头的 tag 时触发
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手动触发时，从 pyproject.toml 读取版本号
            VERSION=$(python -c "import tomllib; f=open('pyproject.toml','rb'); d=tomllib.load(f); print(d['project']['version'])")
            VERSION="v${VERSION}"
          else
            # 从 tag 获取版本号（去掉 refs/tags/ 前缀）
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Get supported AI environments
        id: get_ais
        run: |
          # 从 build-config.json 读取配置
          python << 'PYEOF'
          import json
          import os
          
          with open('build-config.json', 'r') as f:
              config = json.load(f)
          
          ais = ' '.join(sorted(config.get('supported_ais', ['cursor'])))
          platforms = ' '.join(sorted(config.get('supported_platforms', ['linux', 'win'])))
          
          output_file = os.environ.get('GITHUB_OUTPUT', '/dev/stdout')
          with open(output_file, 'a') as f:
              f.write(f"ais={ais}\n")
              f.write(f"platforms={platforms}\n")
          
          print(f"Supported AIs: {ais}")
          print(f"Supported platforms: {platforms}")
          PYEOF

      - name: Build release packages
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          AIS="${{ steps.get_ais.outputs.ais }}"
          PLATFORMS="${{ steps.get_ais.outputs.platforms }}"
          
          # 创建构建产物目录
          mkdir -p .genreleases
          
          echo "Building for AI environments: ${AIS}"
          echo "Building for platforms: ${PLATFORMS}"
          
          # 构建所有 AI 环境和平台的组合
          for ai in ${AIS}; do
            for platform in ${PLATFORMS}; do
              echo "Building ${ai}-${platform}..."
              python build.py ${ai} ${platform}
              
              if [ -d "dist/${ai}-${platform}" ]; then
                cd dist/${ai}-${platform}
                zip -r "../../.genreleases/novel-kit-${ai}-${platform}-${VERSION}.zip" .
                cd ../..
                echo "✓ Built novel-kit-${ai}-${platform}-${VERSION}.zip"
              else
                echo "✗ Failed to build ${ai}-${platform}"
              fi
            done
          done
          
          # 列出构建产物
          echo ""
          echo "Build artifacts:"
          ls -lh .genreleases/
          
          # 检查是否有构建产物
          if [ -z "$(ls -A .genreleases)" ]; then
            echo "Error: No build artifacts generated!"
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: .genreleases/*.zip
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## NovelKit ${{ steps.get_version.outputs.version }}
            
            ### 构建产物
            
            本版本包含以下 AI 环境的构建产物：
            
            - 支持的 AI 环境：${{ steps.get_ais.outputs.ais }}
            - 支持的平台：${{ steps.get_ais.outputs.platforms }}
            
            构建产物命名格式：`novel-kit-{ai-env}-{platform}-{version}.zip`
            
            ### 使用方法
            
            ```bash
            # 安装 CLI
            pip install novel-kit-cli
            
            # 初始化项目（会自动下载构建产物）
            novel-kit init my-novel --ai cursor
            ```
            
            ### 注意
            
            GitHub 自动生成的 Source code 归档包含完整源码，主要用于开发。
            请使用上述构建产物 ZIP 文件进行项目初始化。
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
